# 2025-09-15 -- Cannabis Compliance: AI Automation
> Implementing IDE Scratchpad Habit

---
## Template Guide

### Tag Entries
Use simple markdown markes while jotting:
- `CONCEPT` → something belongs in [Concepts](../concepts/)
- `DECISION` → something belongs in [ADR](../architecture/adr/)
- `HOWTO` → [Recipe](../guides/recipes/)
- `OPEN` -> open question/backlog
- **Example**:
    - `CONCEPT`: Audit Logs need to link every compliance gate → belongs in concepts/audit-logs.md
    - `DECISION`: Will start AI automation with single-log analysis → ADR candidate
    - `HOWTO`: Recipe for adding new compliance gate to automation pipeline
    - `OPEN`: How to handle training verification in Phase 1?

### Graduate Notes into Docs on Milestones
At the end of a feature or learning sprint:
- Scan `journal/` for `CONCEPT:` → promote to `/concepts`
- Scan for `DECISION`: → write ADR (template already exists)
- Scan for `HOWTO`: → stub or complete a recipe
- Copy `OPEN`: into docs/Backlog.md

### Use ADRs & Backlog as Anchors
- **ADRs** capture decisions (so we don’t re-litigate later).
- **Backlog.md** captures “I should doc this later” without breaking our flow.
- This prevents us from derailing into “doc-OCD” mid-build.

### Daily Wrap-Up Habit
At the end of a coding/learning block:
1. Commit code as usual.
2. Copy/paste our scratch notes into docs/journal/YYYY-MM-DD.md.
3. Add a quick commit like:
```makefile
docs: journal notes for Sept 15 (AI Automation Phase 1 kickoff)
```
That way, even if we never polish them, our thought process is versioned and searchable.
4. Copy unresolved OPEN items into docs/Backlog.md.

---

## Audit Automation (`/audit-automation/analyze`)

- **HOWTO**: Route will take auditlog JSON → send to OpenAI → return enriched log
- **DECISION**: MVP will only support single log entry (not batch)
- **CONCEPT**: AI summaries can serve as compliance "lens" across audit logs

### End of day:
- Promote the `DECISION` into `adr/0003-ai-automation-mvp.md`.
- Leave the `HOWTO` in journal for now → stub later into `recipes/Analyze-AuditLogs.md`.
- The `CONCEPT` eventually grows into `concepts/ai-automation.md`.

---

## Note Canvas

### Step 1) AI Enrichment of Audit Logs
#### Task
Connect AI to our existing `AuditLog` stream and enrich each log entry with:
- **Plain-language summary** (what happened, who did it, why it matters).
- **Compliance gate** (Harvest, Packaging, Testing, Transfer, Sale).
- **Status flag** (`pass`, `warn`, `fail`).

#### File/Code Structure
Backend (`server/src`):
```bash
/services/
  aiAutomationService.js   # Handles OpenAI call + enrichment logic
/controllers/
  auditAutomationController.js   # Express controller for /audit-automation/analyze
/routes/
  auditAutomationRoutes.js
```

#### Route Scaffolding
`server/src/routes/auditAutomationRoutes.js`
```js
import express from "express";
import { analyzeAuditLog } from "../controllers/auditAutomationController.js";

const router = express.Router();

router.post("/analyze", analyzeAuditLog);

export default router;
```

`server/src/controllers/auditAutomationController.js`
```js
import { enrichAuditLog } from "../services/aiAutomationService.js";

export const analyzeAuditLog = async (req, res) => {
  try {
    const { log } = req.body; // expecting { log: { ...auditLogData } }

    if (!log) {
      return res.status(400).json({ error: "Missing audit log entry" });
    }

    const enriched = await enrichAuditLog(log);

    res.json({ enriched });
  } catch (err) {
    console.error("Error analyzing audit log:", err);
    res.status(500).json({ error: "Failed to analyze audit log" });
  }
};
```

`server/src/services/aiAutomationService.js`
```js
import OpenAI from "openai";

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function enrichAuditLog(log) {
  // Prompt the AI with audit log details
  const prompt = `
You are an AI compliance assistant. Given an audit log, summarize it for regulators
and map it to the correct compliance gate.

Audit Log: ${JSON.stringify(log, null, 2)}

Return JSON:
{
  "summary": "...",
  "complianceGate": "Harvest|Packaging|Testing|Transfer|Sale|Unknown",
  "status": "pass|warn|fail"
}
  `;

  const response = await openai.chat.completions.create({
    model: "gpt-4o-mini",
    messages: [{ role: "user", content: prompt }],
    temperature: 0.2,
  });

  let enriched;
  try {
    enriched = JSON.parse(response.choices[0].message.content);
  } catch (err) {
    throw new Error("Failed to parse AI response: " + err.message);
  }

  return { ...log, ...enriched };
}
```

#### Example Request
**POST** `/audit-automation/analyze`
```json
{
  "log": {
    "id": 981231,
    "tenantId": 42,
    "timestamp": "2025-09-10T15:45:30.123Z",
    "actor": { "id": 7, "role": "QA" },
    "entity": "Batch",
    "entityId": "BATCH-2025-001",
    "action": "APPROVE_COA",
    "details": { "potency": "18.2% THC" }
  }
}
```
**Response**
```json
{
  "enriched": {
    "id": 981231,
    "tenantId": 42,
    "timestamp": "2025-09-10T15:45:30.123Z",
    "actor": { "id": 7, "role": "QA" },
    "entity": "Batch",
    "entityId": "BATCH-2025-001",
    "action": "APPROVE_COA",
    "details": { "potency": "18.2% THC" },
    "summary": "QA approved COA for batch BATCH-2025-001 (potency 18.2% THC).",
    "complianceGate": "Testing",
    "status": "pass"
  }
}
```

### Universal Test Harness Strategy → Dev Helper AI
1. **Keep Dev Helper AI CLI as the Single CLI Repo**
    - Don't create a new `/cli` in `cannabis-compliance`.
    - All CLI commands live in **dev-helper-ai** under `cli/commands`.
    - Dev Helper becomes our **"control center"** for testing multiple projects.

2. **Add a "Projects Layer" to Dev Helper**
Right now our CLI commands (in dev-helper-ai) assume everything is about Dev Helper (analyze code, explain, fix, history).
→ Add a **namespace or subcommand grouping** for external projects.

3. **Point CLI Commands to the Right Backend**
- In `dev-helper-ai`, add a config file for **project endpoints**:
`cli/utils/projectConfig.js`
```js
export const projectEndpoints = {
  compliance: "http://localhost:4000", // cannabis-compliance backend
  devHelper: "http://localhost:3001",  // dev-helper backend
};
```
- Then in `cli/commands/compliance/analyzeAuditHandlers.js` we do:
```js
import axios from "axios";
import { projectEndpoints } from "../../utils/projectConfig.js";

export default async function analyzeAuditCommand(logFile) {
  const res = await axios.post(
    `${projectEndpoints.compliance}/audit-automation/analyze`,
    { log: JSON.parse(await fs.promises.readFile(logFile, "utf-8")) }
  );
  console.log(JSON.stringify(res.data.enriched, null, 2));
}
```

4. **Keep Tests Centralized**
- Extend existing `cli-test.sh` to include compliance tests.

5. **Version Control Approach**
- **dev-helper-ai** repo → houses our CLI + harness.
- **cannabis-compliance repo** → houses our backend/frontend
- They remain separate, but CLI commands in dev-helper hit endpoints from cannabis-compliance.

That way:
- We get one universal CLI to control all projects.
- We don't duplicate scaffolding.
- We just keep endpoints configurable per prjoect.

#### Net Result
We've architected it in a way that keeps:
- **Endpoints** in config (`projectConfig.js`).
- **Handlers** abstracted (`analyzeAuditHandlers.js`).
- **Commands** composable (`analyzeAuditCommand.js`).
- **CLI root** clean (`cli.js`).

### Wrap-Up Checklist
1. **Commit for `dev-helper-ai`**
```pgsql
feat(cli): add compliance project integration with analyze-audit command

- Added projectConfig.js to centralize backend endpoints
- Implemented compliance analyze-audit CLI command
- Separated logic into analyzeAuditCommand.js + analyzeAuditHandlers.js
- Updated cli.js to register compliance namespace commands
- Added tests/sample-audit.json for audit log enrichment validation
- Extended cli-test.sh with compliance analyze-audit test case

This sets up Dev Helper AI as a universal test harness,
enabling commands to target the Cannabis Compliance backend.
```

2. **Journal Entry (`docs/journal/2025-09-15.md`)**
Log today's key work and tomorrow's plan:
Example:
```md
# 2025-09-15 — Dev Helper AI as Universal Test Harness

## Work Completed
- Added compliance project integration into dev-helper-ai CLI
- Created projectConfig.js for endpoint management
- Implemented analyze-audit command + handler separation
- Updated cli.js with compliance namespace
- Added sample audit log JSON + cli-test.sh compliance test

## Decisions
- DECISION: Dev Helper AI will act as a universal harness across projects
- DECISION: Compliance CLI commands live in dev-helper-ai, not cannabis-compliance repo

## Open Items
- OPEN: Run and validate compliance CLI test tomorrow
- OPEN: Confirm AI enrichment response includes summary + complianceGate

## Next Steps
1. Finish testing compliance analyze-audit command
2. If stable, proceed to Phase 1.5 (batch/sliding-window analysis)
```

3. **Backlog Note (`docs/Backlog.md`)**
Add a quick entry so future me won't forget:
```md
- [ ] Test compliance analyze-audit CLI command (sample-audit.json)
- [ ] Implement Phase 1.5: batch/sliding-window analysis
```

---

# 2025-09-15 — AI Automation Phase 1 Kickoff + Dev Helper AI Harness

## Work Completed
- **Docs Refactor**
  - Reorganized `/docs` folder: added `/concepts`, `/architecture`, moved ADRs.
  - Added `concepts/audit-logs.md` with high-level what/why/how.
  - Expanded `Glossary.md` with SOPs, QA/QC, cGMP, CAPA, Deviation, RBAC, COA, Audit Trail, ESG.
  - Created ADR 0003 for AI Automation MVP (single-log analysis).
  - Started `docs/journal/` workflow for scratchpad notes → docs.

- **AI Automation Phase 1 (Cannabis Compliance Project)**
  - Designed `/audit-automation/analyze` backend route.
  - Implemented service layer prompt for OpenAI to enrich audit logs (summary, compliance gate, status).
  - Defined request/response shape for enriched audit logs.

- **Dev Helper AI as Universal Test Harness**
  - DECISION: Use dev-helper-ai CLI as a universal testing CLI across projects.
  - Added `projectConfig.js` to manage project endpoints.
  - Created compliance `analyze-audit` CLI command.
  - Separated logic into `analyzeAuditCommand.js` + `analyzeAuditHandlers.js`.
  - Updated `cli.js` to register compliance namespace commands.
  - Added `tests/sample-audit.json` and extended `cli-test.sh` with compliance tests.

## Decisions
- ADR 0003: MVP for AI Automation = single log analysis only.
- Dev Helper AI will serve as the universal test harness (no new CLI in cannabis-compliance).

## Open Items
- [ ] Test compliance `analyze-audit` CLI command with sample JSON.
- [ ] Validate AI response includes `summary` + `complianceGate`.
- [ ] Confirm error handling matches existing CLI patterns.

## Next Steps
1. Finish testing compliance analyze-audit command (tomorrow).
2. Move into Phase 1.5 → batch/sliding window anomaly detection.
3. Consider stub for `concepts/ai-automation.md`.
